---
title: TDD大法好
category: TDD
---

这是我在TWI做的一期3分钟闪电演讲：在数字化时代，为什么TDD仍然是敏捷开发的正知正念。

## 为什么必须有自动化测试

正如我在[React单元测试策略及落地](https://ethan.thoughtworkers.me/#/post/2018-07-13-react-unit-testing-strategy)一文中所说，数字化时代的商业软件开发具有VUCA的特点：易变、不确定、复杂、模糊的特点。那么为了应对不确定性，缩短反馈周期是一个自然的思路。而缩短反馈周期的办法有小迭代、框定高价值的MVP快速上线、简单设计等，于是我们看到许多方法论如敏捷、Scrum、XP、精益都在通过类似的思路缩短反馈周期。这背后是企业对IT响应力的诉求：通过更频繁的部署上线获取用户反馈，缩短反馈周期，更快速地做实验并根据用户反馈调整产品，进而在商业竞争中获得竞争力。企业对软件高响应力的诉求，最终会转化到对高质量的诉求上，而传统的手工测试方法是对高质量的阻碍。

Scrum是一个符合敏捷价值观和原则的管理方法，它鲜明地提出迭代和全功能团队的概念，并通过制定沟通计划帮助团队形成快速反馈的节奏。它是一套管理实践。毫无疑问，Scrum的短迭代对于提升响应力是很有帮助的。但是作为中国IT从业人员，我们很容易过度依赖管理上的实践，而不去深入技术实践。这体现在我们仍然缺乏拆分任务的技巧、不做自动化测试、缺乏有效的自动化测试，而是仍然依赖于一个独立的测试部门或全功能团队中的QA这个角色来做手工回归以保障软件质量。很快，随着时间流逝，项目业务变得更加繁杂、人员的流动开始带走上下文——而这两件事情在商业时代的软件项目上一定会发生——开始没有人能同时了解所有的业务，做一次完整的回归测试成本越来越高，没有被手工测试兜住的bug越来越多，质量问题变得更加严重，除了新的需求团队开始疲于应付优先级越来越高的线上问题，业务部门和用户对IT团队的不信任逐渐累积……然后，团队的迭代就永远停留在2周-4周，项目积重难返，再也无力往前快速推进。

所以说，**不做TDD、重构、CI这些核心的技术实践，仅凭管理实践无法从根本上提升质量、提升IT响应力**。可靠、频繁的重构依赖于有效的自动化测试，CI需要有可靠的自动化测试运行在上面，而**TDD则是产出可靠的自动化测试的唯一办法。**

## 为什么TDD是产出可靠的自动化测试的唯一办法

上面说的场景和好处，其实都是自动化测试带来的，而不必然是TDD（测试👉🏻**先行**👈🏻）带来的好处。所以很多同学自然会问，我可不可以不做TDD，同样也能获得自动化测试带来的好处？

回答是**不可以**。因为自动化测试有*无效的自动化测试*和*有效的自动化测试*的差别。不采用测试先行也即是TDD的方式，很难产出质量内建（quality built-in）的、有效的自动化测试。

什么是有效的自动化测试？一个是能支持重构、一个是富有业务表达力。为什么TDD有助于写出这样有效的自动化测试，而不做TDD很难产出这样的自动化测试呢？

任何一个程序员在做开发工作时，都会有自己的一套“流程”或习惯，不论是有意还是无意。比如一个常见的工作流是这样：

1. 写代码；
2. 写一段时间以后停下来看看效果（刷新浏览器或调Postman等工具）
   * 2.1 如果代码不工作就调试一下
   * 2.2 如果代码工作就重复1-2，直到开发任务结束
3. 代码全部写完并且调试完，开始补测试，补到覆盖率足够，提交

这种方法存在几个问题：

* 写代码前没有对任务进行拆分，写到哪算哪。这是一个不可管理的开发过程，既无法管理进度，也无法管理交付风险和技术风险
* 调试过程既不能被自动化、也无法留存业务上下文
* 后补的测试，往往以满足覆盖率为目标，视角完全在一个个的“函数”上，测的是实现，非常脆弱、不支持重构，反而增加了后续的改动负担

TDD的做法是先写一个测试表达你要实现的业务，然后再实现它，也就是所谓的测试先行，我们把调试的步骤挪到编码之前进行。而你要写的测试从哪里来呢？这就要求你在开始一项任务之前，先了解总体的需求和系统架构，并将它们拆解成为一个个互相独立的子任务，这也就是我们说的“任务分解”。于是，一个典型的TDD工作流是这样：

1. 做任务分解。需要通盘考虑要完成的业务需求、当前系统的技术架构以及技术方案，并将总的需求拆解成一个个小的、互相独立的子任务
2. 对于每一个子任务，采用测试先行的方式进行开发：将子任务转化为测试、简单实现、重构
3. 对剩下的子任务，不断重复2的过程，直至开发任务结束

我们可以看到TDD和非TDD工作方法的区分：anyway测试是要写的，TDD只不过把这个步骤提前到了编写实现代码之前完成。但就是这个简单的动作，对产出可靠的自动化测试带来了深远的影响：

* 由于任务是按照业务场景拆分的，通过TDD编写出来的测试天然就是富有业务表达力的
* 使用TDD开发出来的测试天然地支持重构（只要业务场景不变，测试就能通过，而不受函数签名、具体实现的变动而失效）。相比之下，先写实现再写测试的方式补出来的测试很容易从覆盖率、函数实现的视角出发（而不是从质量、业务场景的视角出发），导致测试脆弱、大量使用mock、强依赖于代码实现，实际上无法有效支撑重构
* 由于需要在还没有实现的情况下编写测试，TDD会驱使你提前思考API如何设计（这也是为什么我们说TDD是一种设计方法），这保证了代码的可测试性。相比之下，先写实现后补测试的做法，在实操中“场景”和“实现”往往是混在一起的，导致最后产出的代码往往缺乏结构、职责不清晰，最终难以简单地构造测试

这就是我为什么说，不通过TDD这种测试先行的方式，就得不到可靠有效的自动化测试的原因。“测试先行”的背后要求开发者至少具备：拆解任务的能力、做设计的能力、编写好测试的能力、时刻区分需求与实现的纪律性，以及重构的能力等等，这是一个胜任力。如果你具备这个胜任力，那么你就能做到测试先行，并得到有效的自动化测试；如果你不具备这个胜任力，那么你就做不到测试先行，也就得不到可靠的自动化测试。**这不是选择做不做的问题，而是会不会的问题。**

所以结论就是，想要做好敏捷，想要提高组织的胜任力，关键在于提升团队与个人的技术胜任力，唯一的正道就是扎扎实实练好TDD的基本功。意图依赖于敏捷的管理实践而绕开技术实践，意图依靠本能开发而不切实提升胜任力，无法切实提高团队和组织的敏捷度和响应力。**坚持TDD、直面TDD、练习TDD，仍然是数字化时代应用敏捷方法应该坚持的正知正念**。

## 如何练习TDD

正如前文所说，做好TDD的根本在于测试先行，而测试先行背后要求的是一系列胜任力：任务拆解、软件设计、测试编写、抽象、重构的能力，等等。要提高胜任力，唯有通过练习的方式达成。这里提供一些资料：

* [扫码加入熊节开发的14天TDD练功房](https://user-images.githubusercontent.com/11895199/59976313-3af26100-95f5-11e9-8c93-2805d0b6e5ea.png)。刻意练习永远是你掌握一门技能的第一步
* [极客时间 - TW CTO徐昊的“TDD项目实战70讲”](https://time.geekbang.org/column/article/494207)。作为现东家CTO的课程，我只能说良心推荐，可能是全中国讲TDD最好的课程了，跟着做下来，能有效提高你的认知水平和动手能力~~然而我也是氪了金还没跟着做的差生……~~
* [极客时间 - 郑烨的“程序员测试课”](https://time.geekbang.org/column/article/404286)。这个系列介绍了许多写好测试的方法，~~据郑大群里说是怕挂出测试先行的名号没人报名了~~背后讲的还是TDD
* [这个仓库搜集了一些TDD的练习题，不断增加中](https://github.com/EthanLin-TWer/elegant-tdd)
