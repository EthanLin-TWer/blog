---
title: 一种更加有效的React单元测试及最佳实践（二）
tags: react unit-test tdd rtl react-testing-library jest design-system
---

有效的自动化测试是任何企业级项目的必选项和质量根基。而实践已经证明，在前端仅做组件式的单元测试不够有效。本文将介绍一种更为有效的单元测试方式，让测试能够更好地支撑重构和开发。这套经验曾支撑笔者经历的一个年十亿美元级、历时五年+的交易系统的成功运营和维护演进。

## 太长不读——本文中心观点

正如我在5年前的[React单元测试策略及落地][react单元测试策略]中所说，自动化测试，而且是**有效的自动化测试**，**对于任何一个企业级项目来说都是必选项而不是可选项**。这是由企业项目的两个特点决定的：**人员流动不可避免**、**应用演进不可避免**。这两点不因人的主观意志为转移。应用演进，意味着新的、遗留的业务和代码会越来越多；人员流动，意味着物理上不可能会有一个人能长期、完全地掌握单个应用的所有上下文。因此，希望通过手工测试（开发者自测或者单独的QA团队手测）的方式来保障质量，首先既是低效的，长期来看也是不可能的。

那么，有了自动化测试就可以了吗？答案也不是。我见过许多无效的自动化测试，最痛的莫过于花费许多精力写了测试，却发现测试无法支撑重构，许多简单的重构比如React组件重命名、搬移数据到Context都会挂许多测试，直接对开发效能起负作用。其次，测试缺乏有表达力、有意义的断言，或者测试的描述与断言与真实业务场景脱节（测试断言的是页面上有没有“￥400”，关联的业务场景却是报价能否成功）等等，也都是常见的无效测试模式。这样的无效测试，都不能帮助你留存业务知识、支撑随时随地进行的技术重构，也无法真正助力软件质量和研发效能的提升，久而久之只会让测试变成一场表演，变成不得不应付而又弃之可惜的鸡肋。

你需要的是真正**有效的自动化测试**。

如果你是企业的中层技术管理者（Tech Lead或者Technical Principle等），那么这是你应该关注的问题；如果你是正在努力成为技术骨干的开发者，这篇文章也正是为你准备的。

接下来，我会介绍什么是有效的自动化测试，然后以一个React应用为背景，介绍一个常见且有效的测试策略是什么、作为关键部分的单元测试应该怎么架构、怎么编写，我会给出十分充足的代码样例帮助你和你的团队去落地。最后，我还会介绍这部分关键的单元测试方式有什么挑战，帮助你对这项技术知己知彼。

这套经验是我在过去三年、两个项目上的实践和总结。它成功地帮助我们能够在一个支撑行内年十亿美元级交易数额的应用上，历时5年+、还没上TS的情况下仍能自信地修改和重构代码；它也成功地帮助了我们当前的项目从0到1搭建起有效的测试策略，如今一个具有复杂逻辑的页面已经有4000行测试代码的有效覆盖。这篇文章是实践中诞生的经验和总结。

舞台已经搭好，下面让我们直奔主题~~直接开演~~。

🚧正文内容正在施工中。

## 大纲 / 目录

* 为什么……
  * ~~要做测试？因为项目一定会变大导致依据个人经验的手动测试在人力上不可行、人员一定会流动而导致上下文丢失。任何项目都这样~~
  * 是这个策略？MVVM分离为什么不行？不实际。有了Hooks以后，现代React组件其实就是个组合所有逻辑的地方，所有协调都在这里
  * 有什么好处？支持重构：改功能时测试能有效保障行为、不需要改动相应的测试；越写越顺手，组合式，写新测试相当容易；测试断言声明式。
* 什么是无效的自动化测试？
* 架构（黑马简介）
  * hook：hook的单元测试
  * 其他层的测试：契约测试
  * 使用React Query等global statement management的库
  * 其他hook的测试：副作用，如windows、analytics等。
* 测试架构&例子
  * API mock
  * 组件层
* 新的衍生问题
  * 以什么为“页面”单位？路由或页面组件（Page component）
  * 测试文件过长：抽函数、放弃不必要的断言
  * 测试文件如何组织：以功能组织，写的时候可能跨好几个`describe`/文件，难以发现、难以维护；以页面组织，容易很分散，看不出业务逻辑。
* 有什么挑战？

那么，什么是有效的自动化测试呢？

在React和前端这个上下文中，单元测试不是最优解——集成式的单元测试才是。但我无意发明新的名词，因此，本文所需的只是一个用来指代本文这样一种测试方式的。

挑战是什么：一个有效的测试策略，以及编写测试的能力。
什么是测试策略：

## 与上一版的变化

如果你是上一版[React单元测试策略及落地][react单元测试策略]的读者——

* 可以后补测试——适用于遗留代码、中途学习TDD/测试的团队。
* 支持重构，改动功能的时候测试不会大范围挂。
* reducer/selector由于`useMemo`的存在挪到组件内部了，可以转而变为hooks/utils的单元测试；
* saga建议挪到React Query了，之前的saga/编排层不推荐进行测试了，建议采用最新的测试策略覆盖；

## 什么是有效的自动化测试

## React应用的常见架构

## 测试策略

## 具体代码落地

* 测试代码架构：API DSL（方便的API mock语法）+Fixture（mock数据）+tester（选择器）+expectations（测试断言）
* API mock & DSL
* 组件层tester沉淀和API设计
* 测试主体
  * UI内容断言
  * 用户行为交互
  * API Mock

```typescript
interface DropdownTester {
  getLabel(): string;
  getValue(): string;
  getDisplayText(): string;
}

export const findDropdown = (testId: string): DropdownTester => {
  const getElement = () => screen.getByTestId(testId)
  const getLabel = () => screen.getByTestId(`${testId}-dropdown-label`).textContent 
  const getValue = () => screen.getByTestId(`${testId}-dropdown-input`).getAttribute('value') 
  const getDisplayText = () => { return /* ... */ }

  return { getLabel, getValue, getDisplayText }
}
```

## 挑战

* 有一定的开发成本——相比纯函数而言。
* 有一定的维护成本——需要保证测试间独立性（因为引入了API mock而不是组件级别的mock）、等
* 定位问题的能力相对“绝对的单元测试”有所降低。

## References 

* testing pyramid 
* series from Jimmy

[^automated-tests-for-enterprise-only]: 对于个人项目，自动化测试乃至TDD实践是否必须只跟维护有关，你自己开心就行。

[react单元测试策略]: https://blog.linesh.tw/#/post/2018-07-13-react-unit-testing-strategy
